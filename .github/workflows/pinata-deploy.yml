name: Deploy to IPFS via Pinata + Update ENS on Base

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install ENS dependencies
        run: |
          npm install ethers viem dotenv

      - name: Verify Base RPC
        run: |
          echo "Checking Base RPC connection..."
          curl -X POST ${{ secrets.INFURA_ID }} \
          -H "Content-Type: application/json" \
          -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}'
          echo "‚úÖ Base network verified."
      # 3. Archive site files
      - name: Create site bundle
        run: |
          mkdir -p deploy
          cp -r index.html assets deploy/
          cd deploy && zip -r site_bundle.zip .

      # 4. Upload bundle to Pinata
      - name: Upload to Pinata
        id: pin
        run: |
          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F "file=@deploy/site_bundle.zip")
          echo "$RESPONSE"
          CID=$(echo $RESPONSE | grep -o '"IpfsHash":"[^"]*' | cut -d'"' -f4)
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # 5. Print CID and preview link
      - name: Display CID
        run: |
          echo "üåê New site CID: ${{ steps.pin.outputs.cid }}"

      - name: Gateway URL
        run: |
          echo "https://c3dao.mypinata.cloud/ipfs/${{ steps.pin.outputs.cid }}"

      # 6. Auto-update ENS Contenthash on Base
      - name: Update ENS Contenthash on Base
        env:
          ENS_NAME: "c3dao.eth"
          WALLET_ADDRESS: "0x577688C874B9b81Aa3759CdcE381fb79922e7F27"
          PRIVATE_KEY: ${{ secrets.ENS_WALLET_KEY }}
          INFURA_ID: ${{ secrets.INFURA_ID }}
        run: |
          npm install -g ethers @ensdomains/eth-ens-namehash
          node <<'NODE'
          import { ethers } from 'ethers';
          import namehashLib from '@ensdomains/eth-ens-namehash';
          (async () => {
            const provider = new ethers.JsonRpcProvider(process.env.INFURA_ID);
            const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
            const namehash = namehashLib.hash(process.env.ENS_NAME);
            const resolverAbi = ['function setContenthash(bytes32 node, bytes calldata hash) external'];
            const resolver = new ethers.Contract('0x3671E0C7F39C89A153E9581c6b96A3F2F06b9458', resolverAbi, wallet);
            const cid = process.env.CID || '${{ steps.pin.outputs.cid }}';
            // If you need to convert CID to contenthash, perform correct encoding here:
            // NOTE: The original encoding in your file looked suspect; confirm this logic.
            const encoded = '0x' + Buffer.from('e30101701220' + cid.substring(4), 'utf8').toString('hex');
            await resolver.setContenthash(namehash, encoded);
            console.log('‚úÖ ENS contenthash updated on Base:', process.env.ENS_NAME, cid);
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

      # 7. Success ping (optional)
      - name: Send success ping
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.DEPLOY_WEBHOOK }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"text\": \"‚úÖ C.O.I.L redeployed ‚Äî new CID: https://c3dao.mypinata.cloud/ipfs/${{ steps.pin.outputs.cid }}  | Live at: https://c3dao.eth.limo\"}" \
            $WEBHOOK_URL
