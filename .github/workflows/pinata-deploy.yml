name: Deploy to IPFS and Update ENS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: npm install ethers@6

    - name: Zip site root
      run: |
        echo "Zipping site root..."
        zip -r site_bundle.zip . -x ".github/*" "*.md" "LICENSE"

    - name: Upload ZIP to Pinata
      env:
        PINATA_JWT: ${{ secrets.PINATA_JWT }}
      run: |
        echo "Uploading ZIP to Pinata..."

        RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
          -H "Authorization: Bearer $PINATA_JWT" \
          -F "file=@site_bundle.zip")

        echo "Pinata response: $RESPONSE"

        CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')

        if [ -z "$CID" ] || [ "$CID" = "null" ]; then
          echo "❌ ERROR: CID was null — upload failed."
          exit 1
        fi

        echo "CID=$CID" >> $GITHUB_ENV
        echo "New CID: $CID"

    - name: Update ENS contenthash
      env:
        ETH_PRIVATE_KEY: ${{ secrets.ETH_PRIVATE_KEY }}
        INFURA_KEY: ${{ secrets.INFURA_MAINNET_KEY }}
        CID: ${{ env.CID }}
      run: |
        echo "Updating ENS contenthash..."

        cat << 'EOF' > update-ens.mjs
        import { ethers } from "ethers";

        const cid = process.env.CID;
        const provider = new ethers.InfuraProvider("mainnet", process.env.INFURA_KEY);
        const wallet = new ethers.Wallet(process.env.ETH_PRIVATE_KEY, provider);

        // ENS Public Resolver
        const resolverAddress = "0x4976fb03c32e5b8cfe2b6ccb31c09ba78ebaba41";
        const abi = [
          "function setContenthash(bytes32 node, bytes calldata hash) external"
        ];

        // Encode CID to ENS contenthash
        const contentHash = require("@ensdomains/content-hash");
        const encoded = "0x" + contentHash.encode("ipfs-ns", cid);

        const resolver = new ethers.Contract(resolverAddress, abi, wallet);
        const namehash = ethers.namehash("c3dao.eth");

        console.log("Setting contenthash to:", cid);

        const tx = await resolver.setContenthash(namehash, encoded);
        await tx.wait();

        console.log("ENS updated:", tx.hash);
        EOF

        # Install content-hash encoder
        npm install @ensdomains/content-hash

        node update-ens.mjs
