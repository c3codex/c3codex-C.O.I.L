name: Deploy to IPFS and Update ENS (Ethereum)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECK OUT REPO
      # -----------------------------
      - name: Checkout repo
        uses: actions/checkout@v3

      # -----------------------------
      # NODE
      # -----------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -----------------------------
      # INSTALL DEPS FOR UPDATE SCRIPT
      # -----------------------------
      - name: Install ENS updater dependencies
        run: |
          npm init -y
          npm install viem @ensdomains/content-hash axios

      # -----------------------------
      # UPLOAD TO PINATA (DIR UPLOAD)
      # -----------------------------
      - name: Upload folder to Pinata (IPFS)
        id: upload
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          echo "Uploading site folder to Pinata..."
          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer $PINATA_JWT" \
            -H "pinataOptions: {\"wrapWithDirectory\": true}" \
            -F "file=@./index.html" \
            -F "file=@./css" \
            -F "file=@./js" \
            -F "file=@./assets")

          echo "Pinata response: $RESPONSE"
          CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # -----------------------------
      # UPDATE ENS CONTENTHASH
      # -----------------------------
      - name: Update ENS contenthash on Ethereum
        env:
          NEW_IPFS_CID: ${{ steps.upload.outputs.cid }}
          ETH_PRIVATE_KEY: ${{ secrets.ETH_PRIVATE_KEY }}
          INFURA_ID: ${{ secrets.INFURA_ID }}
        run: |
          echo "Running ENS updater..."
          node scripts/update-ens.mjs

      # -----------------------------
      # DONE
      # -----------------------------
      - name: Job complete
        run: echo "Deployment + ENS update finished."
