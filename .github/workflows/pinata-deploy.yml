name: Deploy to IPFS and Update ENS (Ethereum)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ENS dependencies
        run: |
          npm init -y
          npm install ethers multiformats

      # Upload folder to IPFS
      - name: Upload folder to Pinata (IPFS)
        id: upload
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          echo "Uploading site to Pinata..."

          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer $PINATA_JWT" \
            -H "pinataOptions: {\"wrapWithDirectory\": true}" \
            -F "file=@./index.html" \
            -F "file=@./css" \
            -F "file=@./js" \
            -F "file=@./assets")

          echo "Response: $RESPONSE"
          CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')
          echo "cid=$CID" >> $GITHUB_OUTPUT

      # ENS Update
      - name: Update ENS contenthash on Ethereum
        run: node scripts/update-ens.mjs
        env:
          NEW_IPFS_CID: ${{ steps.upload.outputs.cid }}
          ETH_PRIVATE_KEY: ${{ secrets.ENS_WALLET_KEY }}
          INFURA_ID: ${{ secrets.INFURA_ID }}
