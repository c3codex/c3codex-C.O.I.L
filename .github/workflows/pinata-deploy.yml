name: Deploy to IPFS and Update ENS (Ethereum)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install ethers content-hash axios

      # ---------------------------
      #  Upload root folder to IPFS
      # ---------------------------
      - name: Upload folder to Pinata (IPFS)
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          echo "Uploading root folder to Pinata..."

          RESPONSE=$(curl -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer $PINATA_JWT" \
            -H "pinataOptions: {\"wrapWithDirectory\": true}" \
            -F "file=@./index.html" \
            -F "file=@./css" \
            -F "file=@./js" \
            -F "file=@./assets" )

          echo "Pinata response: $RESPONSE"

          CID=$(echo $RESPONSE | jq -r '.IpfsHash')

          echo "CID=$CID" >> $GITHUB_ENV

      # ---------------------------
      #  Update ENS Contenthash
      # ---------------------------
      - name: Update ENS contenthash on Ethereum
        run: node scripts/update-ens.mjs
        env:
        NEW_IPFS_CID: ${{ steps.upload.outputs.cid }}
        ETH_PRIVATE_KEY: ${{ secrets.ENS_WALLET_KEY }}
        INFURA_ID: ${{ secrets.INFURA_ID }}
        run: |
          echo "Updating ENS contenthash..."

          cat << 'EOF' > update-ens.mjs
          import { ethers } from "ethers";
          import * as contentHash from "content-hash";

          const cid = process.env.CID;
          const provider = new ethers.InfuraProvider("mainnet", process.env.INFURA_KEY);
          const wallet = new ethers.Wallet(process.env.ETH_PRIVATE_KEY, provider);

          const resolverAddress = "0x4976fb03c32e5b8cfe2b6ccb31c09ba78ebaba41"; // ENS Public Resolver
          const abi = [
            "function setContenthash(bytes32 node, bytes calldata hash) external"
          ];

          const encoded = "0x" + contentHash.encode("ipfs-ns", cid);
          const node = ethers.namehash("c3dao.eth");

          console.log("Updating ENS to:", cid);

          const resolver = new ethers.Contract(resolverAddress, abi, wallet);
          const tx = await resolver.setContenthash(node, encoded);
          await tx.wait();

          console.log("ENS Updated:", tx.hash);
          EOF

          node update-ens.mjs
